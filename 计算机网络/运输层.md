## 运输层

运输层协议为运行在不同主机上的应用进程之间提供了逻辑通信（logic communication）功能。

### 多路复用与多路分解

将运输层报文段中的数据交付到正确的套接字的工作称为多路分解（demultiplexing）。在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层，所有这些工作称为多路复用（multiplexing）。

### 无连接运输：UDP

UDP 只是做了运输协议能够做的最少工作，除了复用/分解功能及少量的差错检测外，几乎没有对 IP 增加别的东西。

使用 UDP 时，在发送报文段之前，发送方和接收方的运输层实体之间没有握手，因此，UDP 被称为是无连接的。

有许多应用更适合用 UDP 而不是 TCP：

- 关于发送什么数据以及何时发送的应用层控制更为精细。
- 无须连接建立
- 无连接状态
- 分组首部开销小

UDP 中缺乏拥塞控制能够导致 UDP 发送方和接收方之间的高丢包率，并挤垮了 TCP 会话。

#### UDP 报文段结构

UDP 首部由源端口号、目的端口号、长度和校验和 4 个字段组成，每个字段位两个字节。

#### UDP 校验和

校验和用于确定当 UDP 报文段从源到达目的移动时，其中的比特是否发生了变化。

### 面向连接的运输：TCP

#### TCP报文段结构

首部包含：

- 源端口号和目的端口号
- 32 比特的序号字段（sequence number field）
- 16 比特的接收窗口字段 （receive window field）
- 4 比特的首部长度字段（header length field）
- 可选与变长的选项字段（options field），用于发送方与接收方协商最大报文段长度（MSS）时，或在高速网络环境下用作窗口调节因子时使用。
- 6 比特的标志字段（flag field）
    - ACK 用于指示确认字段中的值是有效的
    - RST 、SYN 和 FIN 用于连接建立和拆除
    - CWR 和 ECE 用于拥塞控制

#### 序号和确认号

TCP 把数据看成一个无结构的、有序的字节流，因为徐浩史建立在传送的字节流智商，而不是建立在传送的报文段的序列之上。一个报文段的序号因此是该报文段首字节的字节流编号。

TCP 只确认字节流中至第一个丢失字节为止的字节，所以 TCP 被称为提供累计确认（cumulative acknowledgment）。

#### 往返时间的估计与超时

1. 估计往返时间

    TCP 采用超时/重传机制来处理报文段的丢失问题。

    加权平均往返时间计算公式如下：
    $$
    EstimatedRTT = (1-α) \cdot EstimatedRTT + α \cdot SampleRTT
    $$
    其中，α 推荐值是 α=0.125

2. 设置和管理重传超时间隔

    超时间隔设为 EstimatedRTT 加上一定余量，当 SampleRTT 值波动较大时，这个余量应该大些；当波动较少时，这个余量应该小些。
    $$
    TimeoutInterval = EstimatedRTT + 4 \cdot DevRTT
    $$

#### 可靠数据传输

TODO

#### 流量控制

流量控制服务（flow-control service）用来消除发送方使接收方缓存溢出的可能性。流量控制因此是一个速度匹配服务，即发送方的发送速率与接收方应用程序的读取速率相匹配。

TCP 通过让发送方维护一个接收窗口（receive window）的变量来提供流量控制。

#### TCP 连接管理

- 三次握手
- 四次挥手

#### TCP 拥塞控制

运行在发送方的 TCP 拥塞控制机制跟踪一个称为拥塞窗口（congestion window）的变量。拥塞窗口表示为 cwnd，它对一个 TCP 发送方能向网络中发送流量的速率进行了限制。

当出现过度的拥塞时，在沿着这条路径上的一台（或多台）路由器的缓存会溢出，引起一个数据报被丢弃。丢弃的数据报接着会引起发送方的丢包事件，发送方就认为在发送方到接收方的路径上出现了拥塞的指示。

发送方的发送速率改变原则：

- 一个丢失的报文段意味着拥塞，因此当丢失报文段时应当降低 TCP 发送方的速率
- 一个确认报文段指示该网络正在向接收方交付发送方的报文段，因此，当对先前未确认报文段的确认到达时，能够增加发送方的速率
- 带宽探测。

TCP 拥塞控制算法主要包括：慢启动、拥塞避免和快速恢复。

1. 慢启动

    在慢启动（slow-start）状态，cwnd 的值以 1 个 MSS 开始并且每当传输的报文段首次被确认就增加 1 个 MSS。这一过程每过一个 RTT，发送速率就翻倍。因此，TCP 发送速率启示慢，但在慢启动阶段以指数增长。

    结束慢启动的指数增长：

    - 如果存在一个由超时指示的丢包事件，TCP 发送方将 cwnd 设置为 1 并重新开始慢启动过程，并将 慢启动阈值 ssthresh 设置为 cwnd / 2
    - 当 cwnd 的值大于等于 ssthresh 的值时，结束慢启动并且 TCP 转移到拥塞避免模式
    - 如果监测到 3 个冗余 ACK，TCP 执行一种快速重传并进入快速恢复状态

2. 拥塞避免

3. 快速恢复