## 并发编程的挑战

### 上下文的切换

时间片是 CPU 分配给各个线程的时间。

CPU 通过时间片分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。但是，在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。所以任务从保存到再加载的过程就是一次上下文切换。

#### 多线程一定快吗

因为线程有创建和上下文切换的开销，多线程不一定比单线程快。

#### 测试上下文切换次数和时长

- 使用 Lmbench3 性能工具可以测量上下文切换的时长

- 使用 vmstat 可以测量上下文切换的次数

#### 如何减少上下文切换

- 无锁并发编程
- CAS 算法
- 使用最少线程，避免创建不需要的线程
- 协程：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换

### 死锁

- 避免一个线程同时获取多个锁
- 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源
- 尝试使用定时锁，使用 lock.tryLock(timeout) 来代替使用内部锁机制
- 对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况

### 资源限制的挑战

资源限制是指进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。

资源限制可能会导致并发程序串行执行。

如果是硬件资源限制，可以使用集群并行执行程序。如果是软件资源限制，可以使用资源池将资源复用。

在资源限制的情况下，根据不同的资源限制调整程序的并发度进行并发编程