# 虚拟机执行子系统

## 类文件结构

### Class 类文件的结构

Class 文件一组以 8 位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在 Class 文件中，中间没有添加任何分隔符。当遇到需要占用 8 位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个 8 位字节进行存储。

Class 文件格式采用一种类似于 C 语言结构体的伪结构来存储数据，这种伪结构中只有两种数据类型：无符号数和表。

无符号数属于基本的数据类型，以 u1、u2、u4、u8 来分别代表 1 个字节、2 个字节、4 个字节和 8 个字节的无符号数。无符号数可以用来描述数字、索引引用、数量值或者按照 UTF-8 编码构成字符串值。

表是由多个无符号数或者其他表作为数据项构成的复合数据类型，所有表都习惯性地以 “_info” 结尾。表用于描述有层次关系的复合结构的数据，整个 Class 文件本质上就是一张表。

#### 魔数与 Class 文件的版本

每个 Class 文件的头 4 个字节称为魔数，它的唯一作用时确定这个文件是否为一个能被虚拟机接受的 Class 文件。

紧接着魔数的 4 个字节存储的是 Class 文件的版本号：第 5 和第 6 个字节是次版本号（Minor Version），第 7 和 第 8 个字节是主版本号（Major Version）。

#### 常量池

紧接着主次版本号之后的事常量池入口，常量池可以理解为 Class 文件之中的资源仓库，它是 Class 文件结构中与其他项目关联最多的数据类型，也是占用 Class 文件空间最大的数据项目之一。同时它还是在 Class 文件中第一个出现的表类型数据项目。

由于常量池中常量的数量是不固定的，所以在常量池的入口需要放置一项 u2 类型的数据，代表常量池容量计数值。

常量池主要存放两大类常量：字面量和符号引用。字面量比较接近于 Java 语言层面的常量概念，如本文字符串、生命为 final 的常量值等。符号引用则属于编译原理方面的概念，包括了：

- 类和接口的全限定名（Fully Qualified Name）
- 字段的名称和描述符（Descriptor）
- 方法的名称和描述符

虚拟机加载 Class 文件的时候进行动态连接，也就是说，在 Class 文件中不会保存各个方法、字段的最终内存布局信息，因此这些字段、方法的符号引用不经过运行期转换的话无法得到真正的内存入口地址，也就无法直接被虚拟机使用。

#### 访问标志

在常量池结束之后，紧接着的两个字节代表访问标志，这个标志用于识别一些类或者接口层次的访问信息，包括：这个 Class 是类还是接口；是否定义为 public 类型；是否定义为 abstract 类型；如果是类的话，是否被声明为 final 等。

#### 类索引、父类索引与接口索引集合

类索引（this_class）和父类索引（super_class）都是一个 u2 类型的数据，接口索引集合（interfaces）是一组 u2 类型的数据的集合，这三项数据用来确定这个类的继承关系。类索引用于确定这个类的全限定名，父类索引用于确定这个类的父类的全限定名，接口索引集合用来描述这个类实现了那些接口，这些被实现的接口将按 implements 语句（如果这个类是接口则应当是 extends 语句）后的接口顺序从左到右排列在接口索引集合中。

#### 字段表集合

用于描述接口或者类中声明的变量。字段包括类级变量以及实例级变量，但不包括在方法内部声明的局部变量。可以包括的信息有：字段的作用域、是实例变量还是类变量（static）、可变性（final）、并发可见性（volatile，是否强制从主内存读写）、可否被序列化（transient）、字段数据类型、字段名称。

#### 方法表集合

方法表结构包括了访问标志、名称索引、描述符索引、属性表集合。

方法里的 Java 代码，经过编译器变成字节码指令后，存放在方法属性表集合中一个名为 “Code” 的属性里面。

在 Java 中，要冲在一个方法，除了要与原方法具有相同的简单名称，还要求必须拥有一个与原方法不同的特征签名。在 Class 文件格式中，如果两个方法有相同的名称和特征签名，但返回值不同，那么也是可以合法共存于同一个 Class 文件中。

#### 属性表集合

在 Class 文件、字段表、方法表都可以携带自己的属性表集合，以用于描述某些场景专有的信息。

### 字节码指令简介

- 字节码与数据类型

在 Java 虚拟机的指令集中，大多数的指令都包含了其操作所对应的数据类型信息。

大部分的指令都没有支持整数类型 byte 、char 、 short 和 boolean 类型。大多数对于 byte 、char 、 short 和 boolean 类型数据的操作，实际上都是使用相应的 int 类型作为运算类型。

- 加载和存储指令

用于将数据在栈帧中的局部变量表和操作数栈之间来回传输。

- 运算指令

用于对两个操作数栈上的值进行某种特定运算，并把结果重新存入到操作栈顶。大体上分为两种：对整形数据进行运算的指令与对浮点型数据进行运算的指令。

- 类型转换指令

将两种不同的数值类型进行相互转换，用于实现用户代码中的显示类型转换操作，或者用来处理字节码指令集中数据类型相关指令无法与数据类型一一对应的问题。

- 对象创建与访问指令

- 操作数栈管理指令

- 控制转移指令
- 方法调用和返回指令
- 异常处理指令
- 同步指令